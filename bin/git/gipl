#!/usr/bin/env bash

# ABOUT
#   gipl shall help to update a local git clone of a remote git repository. All branches and tags are supposed to
#   be pulled.
# CHANGELOG
# V2.4
# - use git gee:v3.6 option for silent decrypting
# V2.3
# - umask handling commented out again
# V2.2
# - git gee decrypt not showing no action lines anymore so that the important lines are more visible
# V2.1
# - set umask for the application
# v2.0
# - version output to stderr
# - adding autostash to git pull
# - adding --tags to git pull to reduce this command to one git call
# - adding version info option -V

#orig_umask=$(umask)
#umask 022
dry=
[ "$1" = '-V' ] && 1>&2 echo 2.5.0 && exit 0
[ "$1" = '-n' ] || [ "$1" = '--dry' ] && dry="echo" && echo DRY run

git rev-parse --show-toplevel &>/dev/null || { 1>&2 echo NOT a git repository. ; umask "$orig_umask" ; exit 1 ; }

declare -gr gitroot="$(git rev-parse --show-toplevel)"

# shallow repositories should not handle tags
shallow=
[ -f "$gitroot/.git/shallow" ] && shallow="--depth 1 --no-tags"
[ ! -f "$gitroot/.git/shallow" ] && shallow="--tags"

# -p :- Before fetching, remove any remote-tracking references that no longer exist on the remote.
$dry git pull -p $shallow "$@"
res=$?

 [ "$res" -eq 0 ] && [ -f "$gitroot/.git/gee" ] && echo "Running git gee decrypt (no action lines suppressed):" && $dry git gee de -s 

#umask "$orig_umask" 


# EOF   - old fashioned comment

