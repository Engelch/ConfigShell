#!/usr/bin/env bash
# shellcheck disable=

function debugSet()             { DebugFlag="TRUE"; return 0; }
function debugUnset()           { DebugFlag=; return 0; }
function debug()                { [ "$DebugFlag" = TRUE ] && echo 'DEBUG:'"$*" 1>&2 ; return 0; }
function debug4()               { [ "$DebugFlag" = TRUE ] && echo 'DEBUG:    ' "$*" 1>&2 ; return 0; }
function debug8()               { [ "$DebugFlag" = TRUE ] && echo 'DEBUG:        ' "$*" 1>&2 ; return 0; }
function debug12()              { [ "$DebugFlag" = TRUE ] && echo 'DEBUG:            ' "$*" 1>&2 ; return 0; }

function usage() {
    cat << HERE
git-status-all -V
git-status-all ( -h | --help )
git-status-all [ -u ] [ dir ] ...

Without a directory, the commands start at your home-directory and at /opt/ConfigShell to
check the status of your git repositories. With arguments, the commands starts at the specified
directories and recursively checks for git repositories and output their status.

-u ::= update if the local repository has no changes (M) and is behind the remote branch
-V ::= output the version   and exit 1
-h ::= output help          and exit 2
HERE
}

function checkGitDir() {
   printf "%35s %s" "$(basename $(pwd))" "remote updating... "
   git remote update &>/dev/null
   echo -n 'done: '
   repo="$(git rev-parse --show-toplevel | sed -E s,"$HOME",~,)"
   status="$(gitStatus)"
   echo -e "$status\033[1;31m repo: \033[1;34m$repo \033[1;0m"
   [ "$1" = '-u' ] && 
      debug '-u option' &&
      [ $(echo $status | grep -c behind) -eq 1 ] &&
      debug '-u option after grepping for behing' &&
      [ $(echo $status | grep -c '^M' ) -eq 0 ] &&
      echo '    pulling...' &&
      git pull --tags 2>&1 | sed 's/^/    /'
}

function versionOption() {
   echo "1.0.1"
   exit 0
}

function main() {
   export -f checkGitDir         # export function to sub-processes
   export -f debug               # export function to sub-processes
   updateIfBehindAndNotModified=

   [ "$1" = "-V" ] || [ "$1" = '--version' ] && versionOption && exit 0
   [ "$1" = "-h" ] || [ "$1" = "--help" ]    && usage && exit 0
   [ "$1" = "-d" ] || [ "$1" = "--debug" ]   && debugSet && shift
   [ "$1" = "-u" ] || [ "$1" = "--update" ]  && updateIfBehindAndNotModified=-u && shift
   [ "$1" = "-d" ] || [ "$1" = "--debug" ]   && debugSet && shift # not fully correct, but ok for testing for us

   [ -n "$1" ] && find "$@" -name .git -execdir bash -c "checkGitDir $updateIfBehindAndNotModified" \;
   [ -z "$1" ] && find . -type d -name .git -execdir bash -c "checkGitDir $updateIfBehindAndNotModified" \;
}

main "$@"

# EOF
