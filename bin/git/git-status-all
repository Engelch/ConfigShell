#!/usr/bin/env bash
# shellcheck disable=

function usage() {
    cat << HERE
git-status-all -V
git-status-all ( -h | --help )
git-status-all [ -u ] [ dir ] ...

Without a directory, the commands start at your home-directory and at /opt/ConfigShell to
check the status of your git repositories. With arguments, the commands starts at the specified
directories and recursively checks for git repositories and output their status.

-u ::= update if the local repository has no changes (M) and is behind the remote branch
-V ::= output the version   and exit 1
-h ::= output help          and exit 2
HERE
}

function checkGitDir() {
    git remote update &>/dev/null
    repo="$(git rev-parse --show-toplevel | sed -E s,"$HOME",~,)"
    status="$(gitStatus)"
    echo -e "$status\033[1;31m repo: \033[1;34m$repo \033[1;0m";
    [ "$1" = '-u' ] && 
      [ $(echo $status | grep -c behind) -eq 1 ] &&
      [ $(echo $status | grep -c '^M' ) -eq 0 ] &&
      git pull --tags
}

export -f checkGitDir       # export function to sub-processes
# alternative, POSIX compliant
# find . | while read file; do dosomething "$file"; done

if [ "$1" = -V ] || [ "$1" = '--version' ] ; then
    cd "$PROFILES_CONFIG_DIR/bin/git" || { 1>&2 echo ERROR, unusual ConfigShell installation ; exit 10 ; }
    [ ! -f ./version.txt ] && { 1>&2 echo ERROR, version of git tools cannot be determined. ; exit 11 ; }
    version.sh
    exit 0
fi

[ "$1" = "-h" ] || [ "$1" = "--help" ] && usage && exit 0

updateIfBehindAndNotModified=
[ "$1" = "-u" ] || [ "$1" = "--update" ] && updateIfBehindAndNotModified=-u && shift

[ -n "$1" ] && find "$@" -name .git -execdir bash -c "checkGitDir $updateIfBehindAndNotModified" \;
[ -z "$1" ] && find . -name .git -execdir bash -c "checkGitDir $updateIfBehindAndNotModified" \;

# EOF
